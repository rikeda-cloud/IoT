#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>//ã“ã‚Œã‚’ã‚‰ã„ã¶ã‚‰ã‚Šã«ã¤ã„ã‹ï¼Ÿã—ã¦ãã ã•ã„

const char* ssid = "WIFISSID";  // Wi-Fi SSID
const char* password = "WIFIãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰";   // Wi-Fi ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

const char* openai_api_url = "https://api.openai.com/v1/chat/completions"; // OpenAI APIã®URL
const char* openai_api_key = "APIã‚­ãƒ¼"; // OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šï¼ˆæœ¬ç‰©ã®ã‚­ãƒ¼ã«ç½®ãæ›ãˆã‚‹ï¼‰

void setup() {
  Serial.begin(115200);
  delay(4000); // ã‚·ãƒªã‚¢ãƒ«ãƒ¢ãƒ‹ã‚¿ã®æº–å‚™å¾…ã¡

  Serial.printf("Wi-Fiã«æ¥ç¶šä¸­: %s\n", ssid);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWi-Fiã«æ¥ç¶šå®Œäº†");
  Serial.print("IPã‚¢ãƒ‰ãƒ¬ã‚¹: ");
  Serial.println(WiFi.localIP());

  sendOpenAIRequest(); // OpenAI APIã‚’å‘¼ã³å‡ºã™
}

void sendOpenAIRequest() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(openai_api_url);
    http.addHeader("Content-Type", "application/json");
    http.addHeader("Authorization", String("Bearer ") + openai_api_key);

    // JSONã®ä½œæˆ
    StaticJsonDocument<512> jsonDoc;
    jsonDoc["model"] = "gpt-4o";
    
    JsonArray messages = jsonDoc.createNestedArray("messages");
    
    JsonObject systemMessage = messages.createNestedObject();
    systemMessage["role"] = "system";
    systemMessage["content"] = "You are a helpful assistant.";

    JsonObject userMessage = messages.createNestedObject();
    userMessage["role"] = "user";
    userMessage["content"] = "æŸæœ¨ç”±ç´€ã®ç”Ÿå¹´æœˆæ—¥ã¯ãªã‚“ã§ã™ã‹ï¼Ÿ1xxx,xx,xxã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ã€Œ1xxx,xx,xxã€ã¨ã ã‘å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ã“ã®éš›ã‚«ã‚®ã‹ã£ã“ã¯ã„ã‚Šã¾ã›ã‚“";

    String jsonData;
    serializeJson(jsonDoc, jsonData);

    Serial.println("é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:");
    Serial.println(jsonData);

    int httpResponseCode = http.POST(jsonData);

    if (httpResponseCode > 0) {
      String response = http.getString();
      Serial.println("ãƒ¬ã‚¹ãƒãƒ³ã‚¹:");
      Serial.println(response);


    //è¿½åŠ éƒ¨åˆ†å§‹ã¾ã‚Šjsonã®ãƒ‘ãƒ¼ã‚¹
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’JSONã¨ã—ã¦è§£æ
      StaticJsonDocument<512> responseDoc;
      DeserializationError error = deserializeJson(responseDoc, response);

      if (!error) {
        // assistantã®contentã‚’å–å¾—
        const char* assistantContent = responseDoc["choices"][0]["message"]["content"];
        Serial.println("\nğŸ’¬ Assistantã®è¿”ç­”:");
        Serial.println(assistantContent);
      } else {
        Serial.println("JSONè§£æã‚¨ãƒ©ãƒ¼");
      }
    //è¿½åŠ éƒ¨åˆ†çµ‚ã‚ã‚Š
    } else {
      Serial.printf("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—: %s\n", http.errorToString(httpResponseCode).c_str());
    }

    http.end();
  } else {
    Serial.println("Wi-FiãŒåˆ‡æ–­ã•ã‚Œã¦ã„ã¾ã™ã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...");
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
      delay(500);
      Serial.print(".");
    }
    Serial.println("\nå†æ¥ç¶šå®Œäº†");
  }
}

void loop() {
  // 60ç§’ã”ã¨ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
  delay(60000);
  sendOpenAIRequest();
}
